version: 2.1

orbs:
  php: circleci/php@1

jobs:
  test-php:
    docker:
      - image: cimg/php:8.1-node
      - image: mysql:8.0
        name: mysql
        environment:
          MYSQL_DATABASE: laravel_test
          MYSQL_USER: user
          MYSQL_PASSWORD: password
          MYSQL_ROOT_PASSWORD: root
    steps:
      - checkout
      - php/install-packages
      - run:
          name: Setup environment file
          command: cp .env.example .env
      - run:
          name: Configure database
          command: |
            echo "DB_CONNECTION=mysql" >> .env
            echo "DB_HOST=mysql" >> .env
            echo "DB_PORT=3306" >> .env
            echo "DB_DATABASE=laravel_test" >> .env
            echo "DB_USERNAME=user" >> .env
            echo "DB_PASSWORD=password" >> .env
      - run:
          name: Generate application key
          command: php artisan key:generate
      - run:
          name: Wait for MySQL
          command: |
            for i in {1..30}; do
              nc -z mysql 3306 && echo "MySQL is up!" && exit 0
              echo "Waiting for MySQL..."
              sleep 2
            done
            echo "MySQL failed to start" && exit 1
      - run:
          name: Clear config cache
          command: php artisan config:clear
      - run:
          name: Run migrations
          command: php artisan migrate --force
      - run:
          name: Run tests
          command: ./vendor/bin/phpunit

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "SHA256:PHpuUx3tNLUkLE3O0BSULMrzvXJ0KHQ6uOSqKTtEdFM"  # Replace with your actual SSH key fingerprint from CircleCI
      - run:
          name: Setup SSH Key & Deploy
            # env:
            #   SSH_PRIVATE_KEY: ${{ secrets.AWS }}
            #   SERVER_IP: ${{ secrets.AWS_SERVER_IP }}
            #   USER: ${{ secrets.AWS_USER }}
          command: |
            # Decode SSH private key from Base64 to prevent formatting issues
            # cat "$AWS_PRIVATE_KEY"

            cat "$AWS_SERVER_IP"
            # echo "$AWS_PRIVATE_KEY" > deploy_key.pem
            # chmod 600 deploy_key.pem
            # ssh-keyscan -H $AWS_SERVER_IP >> ~/.ssh/known_hosts

            # ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@$AWS_SERVER_IP \<< 'EOF'
            #   echo "âœ… Connected to AWS EC2"

            #   # Ensure project directory exists
            #   mkdir -p /home/ubuntu/workspace
            #   cd /home/ubuntu/workspace || exit 1

            #   # Clone or pull latest code
            #   if [ ! -d ".git" ]; then
            #     git clone git@github.com:AymaneQualiso/laravel-circle-ci.git .
            #   else
            #     git reset --hard
            #     git pull origin main || true
            #   fi

            #   # Restart application (Modify as needed)
            #   sudo systemctl restart nginx php-fpm
            # EOF

workflows:
  version: 2
  production_pipeline:
    jobs:
      - test-php
      - deploy:
          requires:
            - test-php
          filters:
            branches:
              only: main
